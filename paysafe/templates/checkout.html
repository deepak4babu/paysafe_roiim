{% extends 'base.html' %}
{% block head %}
<script src="https://hosted.paysafe.com/checkout/v2/paysafe.checkout.min.js"></script>
{% endblock %}
{% block content %}
<div class="container">
    <h1>Enter the amount to checkout</h1>
</br>
</br>
        <div class="form-row">
          <div class="form-group col-md-4">
            <label for="amount">Amount</label>
            <input type="amount" class="form-control" id="amount" name="amount" value="{{ amount }}">
          </div>
        </div>
        
        <button onclick="checkout()" type="submit" class="btn btn-primary">Pay</button>
    </div>
<script>
    function checkout() {
        var amount_to_pay = document.getElementById("amount").value;
        var customer_payload={{ customer_dict|safe }}
        customer_payload["amount"]=parseInt(amount_to_pay)*100
        console.log(customer_payload)
        paysafe.checkout.setup("{{ PUBLIC_API_KEY }}",customer_payload,function(instance, error, result) {
                if (result && result.paymentHandleToken) {
				    console.log(instance)
					console.log(error)
				    console.log(result)
                    console.log(result.paymentHandleToken);
                    // make AJAX call to Payments API
                    var xhr = new XMLHttpRequest();
                    xhr.open("POST", "https://powerful-dusk-51310.herokuapp.com/payment", true);
                    xhr.send(JSON.stringify(result));
                    xhr.onload = function() {
                          console.log("POST request sent")
                          var jsonResponse = JSON.parse(xhr.responseText);
                          console.log(jsonResponse)
                          //console.log(xhr.response) 
                          if(jsonResponse["status"]=="COMPLETED"){
                              instance.showSuccessScreen()
                            } 
                            else 
                            {instance.showFailureScreen("Payment Failed");}

                          //console.log(this.responseText);
                          //var data = JSON.parse(this.responseText);
                          //console.log(data);
                        }

                } else {
                    console.error(error);
                    // Handle the error
                }
            }, 
        
        function(stage, expired) {
            switch(stage) {
                case "PAYMENT_HANDLE_NOT_CREATED": // Handle the scenario
                case "PAYMENT_HANDLE_CREATED": // Handle the scenario
                case "PAYMENT_HANDLE_REDIRECT": // Handle the scenario
                case "PAYMENT_HANDLE_PAYABLE": // Handle the scenario
                default: // Handle the scenario
            }
        });
    }
</script>

{% endblock %}